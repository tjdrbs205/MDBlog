<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title><%= title || 'MDBlog' %></title>
    <!-- Bootstrap CSS -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css"
    />
    <!-- Bootstrap Icons -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css"
    />
    <!-- Google Fonts - Noto Sans KR -->
    <link
      href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap"
      rel="stylesheet"
    />
    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/style.css" />

    <!-- 페이지별 CSS 로드 - 페이지 제목 기반 -->
    <% if (title && (title === '로그인' || title === '회원가입')) { %>
    <link rel="stylesheet" href="/css/auth.css" />
    <% } %> <% if (title && title.includes('관리자')) { %>
    <link rel="stylesheet" href="/css/admin.css" />
    <% } %> <% if (title && title.includes('카테고리')) { %>
    <link rel="stylesheet" href="/css/categories.css" />
    <% } %> <% if (title && title.includes('대시보드')) { %>
    <link rel="stylesheet" href="/css/dashboard.css" />
    <% } %>

    <!-- 디버깅용 -->
    <script>
      console.log("페이지 제목: <%= title %>");
    </script>

    <!-- CSRF Token -->
    <% if (typeof csrfToken !== 'undefined') { %>
    <meta name="csrf-token" content="<%= csrfToken %>" />
    <% } %>
  </head>
  <body>
    <!-- 헤더 부분 -->
    <%- include('../partials/header') %>

    <!-- 플래시 메시지 표시 -->
    <% if (locals.flash && (flash.success?.length > 0 || flash.error?.length > 0
    || flash.info?.length > 0)) { %>
    <div class="container mt-3">
      <% if (flash.success?.length > 0) { %>
      <div class="alert alert-success alert-dismissible fade show" role="alert">
        <%= flash.success %>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="alert"
          aria-label="Close"
        ></button>
      </div>
      <% } %> <% if (flash.error?.length > 0) { %>
      <div class="alert alert-danger alert-dismissible fade show" role="alert">
        <%= flash.error %>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="alert"
          aria-label="Close"
        ></button>
      </div>
      <% } %> <% if (flash.info?.length > 0) { %>
      <div class="alert alert-info alert-dismissible fade show" role="alert">
        <%= flash.info %>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="alert"
          aria-label="Close"
        ></button>
      </div>
      <% } %>
    </div>
    <% } %>

    <!-- 메인 콘텐츠 (Tistory 스타일) -->
    <div class="container mt-4">
      <div class="row">
        <!-- 사이드바 (왼쪽, Tistory 스타일) -->
        <div class="col-md-3">
          <% if (typeof categories !== 'undefined' && typeof tags !==
          'undefined') { %>
          <!-- 프로필 영역 -->
          <div class="card mb-4">
            <div class="card-body text-center">
              <img
                src="/images/default-profile.png"
                alt="Profile"
                class="rounded-circle mb-3"
                style="width: 100px; height: 100px"
              />
              <h5 class="card-title">블로그 소개</h5>
              <p class="card-text text-muted">
                개발 관련 정보와 팁을 공유하는 블로그입니다.
              </p>
              <% if (locals.currentUser) { %>
              <p class="card-text">
                <strong><%= currentUser.username %></strong>님 환영합니다!
              </p>
              <% } else { %>
              <a href="/auth/login" class="btn btn-primary btn-sm">로그인</a>
              <% } %>
            </div>
          </div>

          <!-- 카테고리 영역 -->
          <div class="card mb-4">
            <div class="card-header">
              <h5 class="mb-0"><i class="bi bi-folder me-2"></i>카테고리</h5>
            </div>
            <div class="card-body p-0">
              <ul class="list-group list-group-flush">
                <li
                  class="list-group-item d-flex justify-content-between align-items-center"
                >
                  <a href="/posts" class="text-decoration-none text-dark"
                    >전체 보기</a
                  >
                  <span class="badge bg-primary rounded-pill"
                    ><%= typeof postStats !== 'undefined' ? postStats.total :
                    '전체' %></span
                  >
                </li>
                <% if (categories && categories.length > 0) { %> <%
                categories.forEach(cat => { %>
                <li
                  class="list-group-item d-flex justify-content-between align-items-center"
                >
                  <a
                    href="/posts?category=<%= cat._id %>"
                    class="text-decoration-none text-dark"
                    ><%= cat.name %></a
                  >
                  <span class="badge bg-primary rounded-pill">
                    <%= typeof categoryMap !== 'undefined' &&
                    categoryMap[cat._id.toString()] ?
                    categoryMap[cat._id.toString()] : '0' %>
                  </span>
                </li>
                <% }) %> <% } else { %>
                <li class="list-group-item">등록된 카테고리가 없습니다</li>
                <% } %>
              </ul>
            </div>
          </div>

          <!-- 태그 클라우드 -->
          <div class="card mb-4">
            <div class="card-header">
              <h5 class="mb-0"><i class="bi bi-tags me-2"></i>태그 클라우드</h5>
            </div>
            <div class="card-body">
              <div class="d-flex flex-wrap gap-2">
                <% if (tags && tags.length > 0) { %> <% tags.forEach(tag => { %>
                <a
                  href="/posts?tag=<%= tag._id %>"
                  class="text-decoration-none"
                >
                  <span class="badge bg-secondary fs-6">#<%= tag.name %></span>
                </a>
                <% }) %> <% } else { %>
                <p class="text-muted mb-0">등록된 태그가 없습니다</p>
                <% } %>
              </div>
            </div>
          </div>

          <!-- 최근 게시물 -->
          <div class="card mb-4">
            <div class="card-header">
              <h5 class="mb-0">
                <i class="bi bi-clock-history me-2"></i>최근 게시물
              </h5>
            </div>
            <div class="card-body p-0">
              <ul class="list-group list-group-flush">
                <% if (typeof recentPosts !== 'undefined' && recentPosts &&
                recentPosts.length > 0) { %> <% recentPosts.forEach(post => { %>
                <li class="list-group-item">
                  <a href="/posts/<%= post._id %>" class="text-decoration-none">
                    <div class="d-flex align-items-center">
                      <div class="flex-shrink-0">
                        <% if (post.featuredImage) { %>
                        <img
                          src="<%= post.featuredImage %>"
                          class="me-2"
                          alt="thumbnail"
                          style="width: 40px; height: 40px; object-fit: cover"
                        />
                        <% } else { %>
                        <div
                          class="bg-light me-2 d-flex align-items-center justify-content-center"
                          style="width: 40px; height: 40px"
                        >
                          <i class="bi bi-file-text"></i>
                        </div>
                        <% } %>
                      </div>
                      <div class="flex-grow-1 ms-2">
                        <p class="mb-0 text-truncate"><%= post.title %></p>
                        <small class="text-muted"
                          ><%= new Date(post.createdAt).toLocaleDateString()
                          %></small
                        >
                      </div>
                    </div>
                  </a>
                </li>
                <% }) %> <% } else { %>
                <li class="list-group-item">최근 게시물이 없습니다</li>
                <% } %>
              </ul>
            </div>
          </div>

          <!-- 방문자 통계 -->
          <div class="card mb-4">
            <div class="card-header">
              <h5 class="mb-0"><i class="bi bi-graph-up me-2"></i>통계</h5>
            </div>
            <div class="card-body p-0">
              <ul class="list-group list-group-flush">
                <li class="list-group-item d-flex justify-content-between">
                  <span>오늘 방문자</span>
                  <strong
                    ><%= typeof stats !== 'undefined' ?
                    stats.visits.today.toLocaleString() : '0' %></strong
                  >
                </li>
                <li class="list-group-item d-flex justify-content-between">
                  <span>총 방문자</span>
                  <strong
                    ><%= typeof stats !== 'undefined' ?
                    stats.visits.total.toLocaleString() : '0' %></strong
                  >
                </li>
                <li class="list-group-item d-flex justify-content-between">
                  <span>총 게시물</span>
                  <strong
                    ><%= typeof postStats !== 'undefined' ?
                    postStats.total.toLocaleString() : '0' %></strong
                  >
                </li>
              </ul>
            </div>
          </div>
          <% } else { %>
          <!-- 사이드바 데이터가 없을 경우 -->
          <div class="card">
            <div class="card-body">
              <p class="text-muted">사이드바 데이터를 불러오는 중입니다...</p>
            </div>
          </div>
          <% } %>
        </div>

        <!-- 콘텐츠 영역 (오른쪽) -->
        <div class="col-md-9">
          <% if (typeof errors !== 'undefined' && errors && errors.length > 0) {
          %>
          <div class="alert alert-danger">
            <ul class="mb-0">
              <% errors.forEach(error => { %>
              <li><%= error %></li>
              <% }) %>
            </ul>
          </div>
          <% } %>

          <!-- 페이지 콘텐츠 시작 -->
          <% if (typeof body !== 'undefined') { %>
          <!-- 문자열로 전달된 전체 콘텐츠 경우 -->
          <%- body %> <% } else { %>
          <!-- view 이름으로 다른 템플릿을 include하는 경우 -->
          <%- include(locals.contentView ? ('../' + locals.contentView) :
          '../partials/loading') %> <% } %>
          <!-- 페이지 콘텐츠 끝 -->
        </div>
      </div>
    </div>

    <!-- 푸터 부분 -->
    <%- include('../partials/footer') %>

    <!-- jQuery 추가 -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <!-- Bootstrap JS Bundle (Popper 포함) -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>

    <!-- 자동 알림 닫기 및 드롭다운 초기화 -->
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        // 5초 후 자동으로 알림 닫기
        setTimeout(function () {
          const alerts = document.querySelectorAll(".alert");
          alerts.forEach(function (alert) {
            if (bootstrap && bootstrap.Alert) {
              const bsAlert = new bootstrap.Alert(alert);
              bsAlert.close();
            }
          });
        }, 5000);

        // 드롭다운 메뉴 수동 초기화
        var dropdownElementList = [].slice.call(
          document.querySelectorAll(".dropdown-toggle")
        );
        dropdownElementList.forEach(function (dropdownToggleEl) {
          if (bootstrap && bootstrap.Dropdown) {
            new bootstrap.Dropdown(dropdownToggleEl);
          }
        });

        // 추가적인 드롭다운 기능 처리
        document
          .querySelectorAll(".dropdown-toggle")
          .forEach(function (element) {
            element.addEventListener("click", function (e) {
              e.preventDefault();
              e.stopPropagation();

              // 클릭된 요소의 다음 형제 요소 (드롭다운 메뉴)를 토글
              var dropdownMenu = this.nextElementSibling;
              if (dropdownMenu.classList.contains("show")) {
                dropdownMenu.classList.remove("show");
              } else {
                // 다른 열린 드롭다운 메뉴 닫기
                document
                  .querySelectorAll(".dropdown-menu.show")
                  .forEach(function (menu) {
                    menu.classList.remove("show");
                  });
                dropdownMenu.classList.add("show");
              }
            });
          });

        // 드롭다운 외부 클릭 시 닫기
        document.addEventListener("click", function (e) {
          if (!e.target.closest(".dropdown")) {
            document
              .querySelectorAll(".dropdown-menu.show")
              .forEach(function (menu) {
                menu.classList.remove("show");
              });
          }
        });
      });
    </script>
  </body>
</html>
